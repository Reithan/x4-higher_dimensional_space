<?xml version="1.0" encoding="utf-8"?>
<mdscript name="hds_yvary_lib">
  <cues>

    <!-- Function-like library. Call with <run_actions ref="md.hds_yvary_lib.HDSYV_VaryY"><param .../></run_actions> -->
    <library name="HDSYV_VaryY" purpose="run_actions">
      <params>
        <param name="x"/>
        <param name="y" default="0"/>
        <param name="z"/>
        <param name="cx" default="0"/>
        <param name="cz" default="0"/>
        <param name="R"/>
        <param name="margin"   default="0.02"/>
        <param name="q"        default="0.1"/>
        <param name="absolute" default="true"/>
        <param name="save_seed" default="0"/>
        <param name="obj_key"   default="0"/>
      </params>

      <actions>
        <!-- geometry -->
        <set_value name="$dx"   exact="$x - $cx"/>
        <set_value name="$dz"   exact="$z - $cz"/>
        <set_value name="$r"    exact="sqrt($dx*$dx + $dz*$dz)"/>
        <set_value name="$Rim"  exact="(1 + $margin) * $R"/>

        <!-- outside rim -> echo input -->
        <do_if value="$r ge $Rim">
          <set_value name="$out_x" exact="$x"/>
          <set_value name="$out_y" exact="$y"/>
          <set_value name="$out_z" exact="$z"/>
          <set_value name="$out_ymax" exact="0"/>
          <cancel_cue cue="this"/>
        </do_if>

        <!-- ymax = sqrt(max(0, Rim^2 - r^2)) -->
        <set_value name="$d" exact="$Rim*$Rim - $r*$r"/>
        <do_if value="$d lt 0"><set_value name="$d" exact="0"/></do_if>
        <set_value name="$ymax" exact="sqrt($d)"/>

        <!-- bias weaker near rim -->
        <set_value name="$rho" exact="0"/><do_if value="$Rim gt 0"><set_value name="$rho" exact="$r / $Rim"/></do_if>
        <set_value name="$amp" exact="$ymax * (1 - $rho)"/>

        <!-- stateless 'hash' uniforms in [0,1] via sin() -->
        <set_value name="$sbase" exact="$save_seed + $obj_key * 0.61803398875"/>
        <set_value name="$a1" exact="$x*$q*12.9898 + $z*$q*78.233 + $sbase*37.719"/>
        <set_value name="$u1" exact="(sin($a1) + 1) * 0.5"/>

        <set_value name="$a2" exact="($x+17)*$q*12.9898 + ($z-11)*$q*78.233 + ($sbase+29)*37.719"/>
        <set_value name="$u2" exact="(sin($a2) + 1) * 0.5"/>

        <set_value name="$a3" exact="($x-7)*$q*12.9898 + ($z+23)*$q*78.233 + ($sbase-41)*37.719"/>
        <set_value name="$u3" exact="(sin($a3) + 1) * 0.5"/>

        <!-- magnitude + sign -->
        <set_value name="$yabs" exact="$amp * ($u1 * $u2)"/>
        <set_value name="$sign" exact="-1"/><do_if value="$u3 ge 0.5"><set_value name="$sign" exact="1"/></do_if>
        <set_value name="$newy" exact="$sign * $yabs"/>

        <!-- 'nudge' mode clamped into [-ymax, ymax] -->
        <do_if value="not $absolute">
          <set_value name="$tmpy" exact="$y + $newy"/>
          <do_if value="$tmpy gt  $ymax"><set_value name="$tmpy" exact="$ymax"/></do_if>
          <do_if value="$tmpy lt -$ymax"><set_value name="$tmpy" exact="-$ymax"/></do_if>
          <set_value name="$newy" exact="$tmpy"/>
        </do_if>

        <!-- outputs (in callerâ€™s scope) -->
        <set_value name="$out_x"    exact="$x"/>
        <set_value name="$out_y"    exact="$newy"/>
        <set_value name="$out_z"    exact="$z"/>
        <set_value name="$out_ymax" exact="$ymax"/>
      </actions>
    </library>

  </cues>
</mdscript>
