<?xml version="1.0" encoding="utf-8"?>
<mdscript name="hds_rng_sphere_lib">
    <cues>

        <!-- Random point in a sphere centered at (cx,cy,cz) with biased radius and Y "squash".
         Call with <run_actions ref="md.hds_rng_sphere_lib.HDS_RNG_Sphere_RandPoint">â€¦</run_actions>
         Params:
            - center (position) OR (cx,cy,cz) lengths (center wins if given)
            - Rmin (length) : minimum distance to offset  from center position
            - R (length) : sphere radius
            - squash (float, default 1.0f): 1.0f = no squash; 0.0f = fully flattened
         Outputs (in caller scope): $out_x, $out_y, $out_z, $out_pos
        -->
        <library name="HDS_RNG_Sphere_RandPoint" purpose="run_actions">
            <params>
                <param name="center" default="null" />
                <param name="cx" default="0" />
                <param name="cy" default="0" />
                <param name="cz" default="0" />
                <param name="Rmin" default="0" />
                <param name="R" />
                <param name="squash" default="1.0f" />
            </params>

            <actions>
                <!-- Resolve center -->
                <do_if value="typeof $center != datatype.null">
                    <set_value name="$cx" exact="$center.x" />
                    <set_value name="$cy" exact="$center.y" />
                    <set_value name="$cz" exact="$center.z" />
                </do_if>

                <!-- radius fraction s in [0,1], mixed uniform/averaged bias -->
                <do_if value="true" chance="50">
                    <set_value name="$sum" exact="[0.0,1.0].randominrange" />
                </do_if>
                <do_else>
                    <set_value name="$sum" exact="0.0" />
                    <set_value name="$k" exact="0" />
                    <do_all exact="5" counter="$idx">
                        <set_value name="$k" exact="$k + 1" />
                        <set_value name="$sum" operation="add" exact="[0.0,0.2].randominrange" />
                    </do_all>
                </do_else>
                <set_value name="$r" exact="(($R - $Rmin) * $sum) + $Rmin" />

                <!-- random direction, uniform on sphere -->
                <set_value name="$pi" exact="3.141592653589793" />
                <set_value name="$u" exact="2.0 * [0.0,1.0].randominrange - 1.0" />        <!-- cos(theta) ~U(-1,1) -->
                <set_value name="$phi" exact="2.0 * $pi * [0.0,1.0].randominrange" />
                <set_value name="$t" exact="sqrt(1.0 - $u*$u)" />
                <set_value name="$dirx" exact="$t * cos($phi)" />
                <set_value name="$diry" exact="$u" />
                <set_value name="$dirz" exact="$t * sin($phi)" />

                <set_value name="$x" exact="$cx + ($r * $dirx)" />
                <set_value name="$y" exact="$cy + ($r * $diry * $squash)" />
                <set_value name="$z" exact="$cz + ($r * $dirz)" />

                <!-- output -->
                <return value="position.[$x, $y, $z]" />
            </actions>
        </library>

    </cues>
</mdscript>